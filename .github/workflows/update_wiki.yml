name: Update Wiki

on:
  schedule:
    # cron: '分 时 日 月 星期'
    # UTC 1:00 = 北京时间 09:00
    - cron: '0 1 * * 1,3,5'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write  # 显式声明权限，确保能 Push 代码和创建 Release

jobs:
  update-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          
          # 1. 安装系统级依赖
          # libopencc-dev: 确保 opencc Python 库能顺利编译
          # libime-bin: 构建 fcitx5 词库所需
          sudo apt-get install -y libime-bin python3 python3-pip wget gzip git libopencc-dev
          
          # 2. 赋予脚本执行权限
          chmod +x *.py
          
          # 3. 安装 Python 第三方库
          pip3 install requests tenacity regex opencc pypinyin

      - name: Check for latest upstream version
        id: check_version
        run: |
          # 1. 获取 dumps 页面内容
          # 2. 提取类似 2025xxxx 的日期格式
          # 3. 降序排列并取第一个，即为最新版本
          LATEST_VERSION=$(curl -s https://dumps.wikimedia.org/zhwiki/ | grep -oE '20[0-9]{6}' | sort -rn | head -n 1)
          
          echo "Latest upstream version: $LATEST_VERSION"
          
          # 读取当前 Makefile 中的版本 (兼容 VERSION=xxx 和 VERSION ?= xxx)
          CURRENT_VERSION=$(grep "VERSION ?=" Makefile | awk '{print $3}') || $(grep "VERSION=" Makefile | awk '{print $2}')
          echo "Current local version: $CURRENT_VERSION"
          
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "New version detected!"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Makefile and Build
        if: steps.check_version.outputs.has_update == 'true'
        run: |
          NEW_VER=${{ steps.check_version.outputs.version }}
          
          # 更新 Makefile 版本号
          sed -i "s/^VERSION.*/VERSION ?= $NEW_VER/" Makefile
          
          # 再次确保权限 (保险起见)
          chmod +x *.py
          
          echo "Building version $NEW_VER..."
          # 运行构建
          make all
          make build_rime_dict

      - name: Commit and Push changes
        if: steps.check_version.outputs.has_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 关键：只提交 Makefile，不提交大文件
          git add Makefile
          git commit -m "chore: auto update to version ${{ steps.check_version.outputs.version }}"
          
          git push

      - name: Create Release
        if: steps.check_version.outputs.has_update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_version.outputs.version }}
          name: Dictionary Update ${{ steps.check_version.outputs.version }}
          files: |
            *.dict
            *.dict.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
