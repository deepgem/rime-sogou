name: Update Sogou Hotwords

on:
  schedule:
    - cron: '0 22 * * *'  # åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # è™½ç„¶ Linux ç‰ˆé€šå¸¸æ˜¯ç‹¬ç«‹å‘å¸ƒçš„ï¼Œä½†å®‰è£… .NET è¿è¡Œæ—¶ä½œä¸ºä¿é™©
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download Latest ImewlConverter
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        mkdir -p tool
        echo "ğŸ” Fetching latest release from studyzy/imewlconverter..."
        
        # ä¸‹è½½ Linux x64 ç‰ˆæœ¬
        gh release download --repo studyzy/imewlconverter -p "*linux-x64.tar.gz" -D tool
        
        echo "ğŸ“¦ Extracting..."
        tar -xvf tool/*linux-x64.tar.gz -C tool
        
        # è°ƒè¯•ï¼šå†æ¬¡æ‰“å°æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
        echo "ğŸ“‚ File list:"
        ls -R tool

    - name: Download Sogou Scel
      run: |
        wget -O sogou.scel "https://pinyin.sogou.com/d/dict/download_cell.php?id=4&name=ç½‘ç»œæµè¡Œæ–°è¯"

    - name: Convert to Rime
      run: |
        mkdir -p output
        
        echo "ğŸ” Locating ImeWlConverterCmd..."
        
        # ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾åä¸º ImeWlConverterCmd çš„æ–‡ä»¶
        # -type f: æ‰¾æ–‡ä»¶
        # -name: ç²¾ç¡®åŒ¹é…æ–‡ä»¶å (å¿½ç•¥å¤§å°å†™ä»¥é˜²ä¸‡ä¸€)
        EXE_PATH=$(find tool -type f -iname "ImeWlConverterCmd" | head -n 1)
        
        if [ -z "$EXE_PATH" ]; then
            echo "âŒ CRITICAL ERROR: Could not find 'ImeWlConverterCmd'!"
            echo "Please check the 'File list' log above."
            exit 1
        fi
        
        echo "âœ… Found Binary at: $EXE_PATH"
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x "$EXE_PATH"
        
        # ç›´æ¥è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ (ä¸éœ€è¦ dotnet å‘½ä»¤å‰ç¼€)
        "$EXE_PATH" -i:scel sogou.scel -o:rime temp_body.yaml

    - name: Add Rime Header
      run: |
        OUT_FILE="output/sogou_pop.dict.yaml"
        CURRENT_DATE=$(date +%Y-%m-%d)
        
        # å†™å…¥æ ‡å‡† Rime å¤´
        cat <<EOF > $OUT_FILE
        ---
        name: sogou_pop
        version: "$CURRENT_DATE"
        sort: by_weight
        ...

        EOF
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†ä¸´æ—¶æ–‡ä»¶
        if [ -f "temp_body.yaml" ]; then
            cat temp_body.yaml >> $OUT_FILE
            rm sogou.scel temp_body.yaml
            rm -rf tool
            echo "âœ… Conversion successful!"
        else
            echo "âŒ Error: temp_body.yaml was not generated."
            exit 1
        fi

    - name: Commit and Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore: auto update hotwords ($CURRENT_DATE)"
        file_pattern: output/*.yaml
