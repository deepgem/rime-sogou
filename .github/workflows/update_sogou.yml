name: Update Sogou Hotwords

# è§¦å‘æœºåˆ¶ï¼š
# 1. å®šæ—¶ï¼šåŒ—äº¬æ—¶é—´æ¯å¤©æ—©ä¸Š 6:00 (UTC 22:00)
# 2. æ‰‹åŠ¨ï¼šå¯ä»¥åœ¨ Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡»è§¦å‘
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

# èµ‹äºˆå†™æƒé™ä»¥ä¾¿æäº¤ä»£ç 
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2. é…ç½® .NET ç¯å¢ƒ
    # ImewlConverter åŸºäº .NET å¼€å‘ï¼Œæ¨èä½¿ç”¨ .NET 8 (LTS)
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # 3. åŠ¨æ€ä¸‹è½½æœ€æ–°ç‰ˆ ImewlConverter (Linux-x64)
    # ä½¿ç”¨ gh å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¼šè‡ªåŠ¨è§£æ "latest" æ ‡ç­¾
    - name: Download Latest ImewlConverter
      env:
        GH_TOKEN: ${{ github.token }} # gh å‘½ä»¤éœ€è¦ tokenï¼ŒGitHub ä¼šè‡ªåŠ¨æä¾›
      run: |
        mkdir tool
        echo "ğŸ” Fetching latest release from studyzy/imewlconverter..."
        
        # âš ï¸ å…³é”®ä¿®æ­£ï¼šä½¿ç”¨ -p "*linux-x64.tar.gz" ç²¾ç¡®åŒ¹é… x64 ç‰ˆæœ¬
        # é¿å…ä¸‹è½½åˆ° arm64 ç‰ˆæœ¬å¯¼è‡´æ— æ³•è¿è¡Œ
        gh release download --repo studyzy/imewlconverter -p "*linux-x64.tar.gz" -D tool
        
        # è§£å‹ä¸‹è½½çš„æ–‡ä»¶
        echo "ğŸ“¦ Extracting..."
        tar -xvf tool/*linux-x64.tar.gz -C tool
        
        # åˆ—å‡ºæ–‡ä»¶ç»“æ„ä»¥ä¾›è°ƒè¯•
        ls -R tool

    # 4. ä¸‹è½½æœç‹—ç½‘ç»œæµè¡Œæ–°è¯ Scel æ–‡ä»¶
    - name: Download Sogou Scel
      run: |
        # id=4 æ˜¯ç½‘ç»œæµè¡Œæ–°è¯
        wget -O sogou.scel "https://pinyin.sogou.com/d/dict/download_cell.php?id=4&name=ç½‘ç»œæµè¡Œæ–°è¯"

    # 5. æ‰§è¡Œè½¬æ¢ (Scel -> Rime)
    - name: Convert to Rime
      run: |
        mkdir -p output
        
        # åŠ¨æ€å®šä½ DLL æ–‡ä»¶è·¯å¾„
        # é˜²æ­¢è§£å‹åç›®å½•ç»“æ„å˜åŒ–ï¼ˆä¾‹å¦‚å¤šäº†ä¸€å±‚æ–‡ä»¶å¤¹ï¼‰å¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶
        DLL_PATH=$(find tool -name "ImeWlConverter.dll" | head -n 1)
        
        if [ -z "$DLL_PATH" ]; then
          echo "âŒ Error: ImeWlConverter.dll not found!"
          exit 1
        fi
        
        echo "ğŸ›  Using converter at: $DLL_PATH"
        
        # æ‰§è¡Œè½¬æ¢
        # -i:scel è¾“å…¥æ ¼å¼
        # -o:rime è¾“å‡ºæ ¼å¼
        dotnet "$DLL_PATH" -i:scel sogou.scel -o:rime temp_body.yaml

    # 6. æ·»åŠ  Rime æ ‡å‡†å¤´ä¿¡æ¯å¹¶æ•´åˆ
    - name: Add Rime Header
      run: |
        OUT_FILE="output/sogou_pop.dict.yaml"
        CURRENT_DATE=$(date +%Y-%m-%d)
        
        # å†™å…¥æ ‡å‡† Rime å¤´
        # è¿™é‡Œçš„ EOF å—ç”¨äºä¸€æ¬¡æ€§å†™å…¥å¤šè¡Œæ–‡æœ¬
        cat <<EOF > $OUT_FILE
        ---
        name: sogou_pop
        version: "$CURRENT_DATE"
        sort: by_weight
        ...

        EOF
        
        # è¿½åŠ è½¬æ¢åçš„è¯æ¡å†…å®¹
        cat temp_body.yaml >> $OUT_FILE
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm sogou.scel temp_body.yaml
        rm -rf tool

    # 7. æäº¤æ›´æ”¹åˆ°ä»“åº“
    - name: Commit and Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore: auto update hotwords ($CURRENT_DATE)"
        file_pattern: output/*.yaml
