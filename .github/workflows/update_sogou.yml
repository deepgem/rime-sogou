name: Update Sogou Hotwords

on:
  schedule:
    - cron: '0 22 * * *'  # åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download Latest ImewlConverter
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        mkdir tool
        echo "ğŸ” Fetching latest release from studyzy/imewlconverter..."
        
        # ç²¾ç¡®ä¸‹è½½ linux-x64 ç‰ˆæœ¬
        gh release download --repo studyzy/imewlconverter -p "*linux-x64.tar.gz" -D tool
        
        echo "ğŸ“¦ Extracting..."
        tar -xvf tool/*linux-x64.tar.gz -C tool
        
        # æ‰“å°æ–‡ä»¶åˆ—è¡¨ä»¥ä¾›è°ƒè¯•ï¼ˆè¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œèƒ½è®©æˆ‘ä»¬åœ¨æ—¥å¿—é‡Œçœ‹åˆ°åˆ°åº•è§£å‹å‡ºäº†ä»€ä¹ˆï¼‰
        echo "ğŸ“‚ File list in tool directory:"
        ls -R tool

    - name: Download Sogou Scel
      run: |
        wget -O sogou.scel "https://pinyin.sogou.com/d/dict/download_cell.php?id=4&name=ç½‘ç»œæµè¡Œæ–°è¯"

    - name: Convert to Rime
      run: |
        mkdir -p output
        
        echo "ğŸ” Searching for converter binary..."
        
        # 1. å°è¯•æŸ¥æ‰¾ Linux å¯æ‰§è¡Œæ–‡ä»¶ (æ— åç¼€, å¿½ç•¥å¤§å°å†™)
        # -type f: å¿…é¡»æ˜¯æ–‡ä»¶
        # -iname: å¿½ç•¥å¤§å°å†™åŒ¹é…
        # ! -name "*.*": æ’é™¤å¸¦åç¼€çš„æ–‡ä»¶(æ¯”å¦‚ .dll, .config)
        EXE_PATH=$(find tool -type f -iname "imewlconverter" ! -name "*.*" | head -n 1)
        
        # 2. å¦‚æœæ²¡æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°è¯•æ‰¾ .dll (å…¼å®¹æ—§ç‰ˆæœ¬)
        if [ -z "$EXE_PATH" ]; then
            DLL_PATH=$(find tool -type f -iname "imewlconverter.dll" | head -n 1)
        fi
        
        # å¼€å§‹è½¬æ¢é€»è¾‘
        if [ -n "$EXE_PATH" ]; then
            echo "âœ… Found Executable: $EXE_PATH"
            chmod +x "$EXE_PATH"
            "$EXE_PATH" -i:scel sogou.scel -o:rime temp_body.yaml
            
        elif [ -n "$DLL_PATH" ]; then
            echo "âœ… Found DLL: $DLL_PATH"
            dotnet "$DLL_PATH" -i:scel sogou.scel -o:rime temp_body.yaml
            
        else
            echo "âŒ Error: Could not find 'ImeWlConverter' executable or 'ImeWlConverter.dll' in tool directory."
            echo "Please check the 'File list' step logs above."
            exit 1
        fi

    - name: Add Rime Header
      run: |
        OUT_FILE="output/sogou_pop.dict.yaml"
        CURRENT_DATE=$(date +%Y-%m-%d)
        
        cat <<EOF > $OUT_FILE
        ---
        name: sogou_pop
        version: "$CURRENT_DATE"
        sort: by_weight
        ...

        EOF
        
        cat temp_body.yaml >> $OUT_FILE
        
        rm sogou.scel temp_body.yaml
        rm -rf tool

    - name: Commit and Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore: auto update hotwords ($CURRENT_DATE)"
        file_pattern: output/*.yaml
